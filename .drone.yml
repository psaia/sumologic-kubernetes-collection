---
kind: pipeline
type: docker
name: dev

concurrency:
  limit: 1

trigger:
  paths:
    include:
      - modules/**
      - terraform/*

steps:
  - name: format
    image: hashicorp/terraform:0.12.26
    commands:
      - terraform fmt -write=false -list -diff -check -recursive terraform

  - name: plan
    image: jmccann/drone-terraform:6.3-0.12.20
    settings:
      tf_version: 0.12.26
      root_dir: terraform
      actions:
        - validate
        - plan
      init_options:
        lock-timeout: 5m
        backend-config:
           - "bucket=remote-state"
           - "prefix=nytimes/dv-sumologic-test"
    environment:
      SUMOLOGIC_ACCESSID:
        from_secret: test_access_id
      SUMOLOGIC_ACCESSKEY:
        from_secret: test_access_key
      SUMOLOGIC_ENVIRONMENT: us2
      GOOGLE_CREDENTIALS:
        from_secret: GOOGLE_CREDENTIALS
    when:
      event:
        - push
        - pull_request
      branch:
        - main
        - test

#   - name: apply
#     image: jmccann/drone-terraform:6.3-0.12.20
#     settings:
#       tf_version: 0.12.26
#       root_dir: terraform
#       actions:
#         - apply
#       init_options:
#         lock-timeout: 5m
#         backend-config:
#            - "bucket=remote-state"
#            - "prefix=nytimes/dv-sumologic-test"
#     environment:
#       SUMOLOGIC_ACCESSID:
#         from_secret: test_access_id
#       SUMOLOGIC_ACCESSKEY:
#         from_secret: test_access_key
#       SUMOLOGIC_ENVIRONMENT: us2
#       GOOGLE_CREDENTIALS:
#         from_secret: GOOGLE_CREDENTIALS
#     when:
#       event:
#         - push
#       branch:
#         - main
#         - test

---
kind: pipeline
type: docker
name: prd

concurrency:
  limit: 1

trigger:
  paths:
    include:
      - modules/**
      - terraform/*

depends_on:
  - dev

steps:
  - name: plan
    image: jmccann/drone-terraform:6.3-0.12.20
    settings:
      tf_version: 0.12.26
      root_dir: terraform
      actions:
        - validate
        - plan
      init_options:
        lock-timeout: 5m
        backend-config:
          - "bucket=remote-state"
          - "prefix=nytimes/dv-sumologic"
    environment:
      SUMOLOGIC_ACCESSID:
        from_secret: access_id
      SUMOLOGIC_ACCESSKEY:
        from_secret: access_key
      SUMOLOGIC_ENVIRONMENT: us1
      GOOGLE_CREDENTIALS:
        from_secret: GOOGLE_CREDENTIALS
    when:
      event:
        - push
        - pull_request
      branch:
        - main
        - test

  - name: apply
    image: jmccann/drone-terraform:6.3-0.12.20
    settings:
      tf_version: 0.12.26
      root_dir: terraform
      actions:
        - apply
      init_options:
        lock-timeout: 5m
        backend-config:
          - "bucket=remote-state"
          - "prefix=nytimes/dv-sumologic"
    environment:
      SUMOLOGIC_ACCESSID:
        from_secret: access_id
      SUMOLOGIC_ACCESSKEY:
        from_secret: access_key
      SUMOLOGIC_ENVIRONMENT: us1
      GOOGLE_CREDENTIALS:
        from_secret: GOOGLE_CREDENTIALS
    when:
      event:
        - push
      branch:
        - main

---
kind: signature
hmac: 7b69d0e3ce6c92ea981af77795a0c8e1d939cf0daf9667a2560bc58be669157b

...
